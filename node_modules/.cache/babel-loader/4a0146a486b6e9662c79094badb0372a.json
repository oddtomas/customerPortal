{"ast":null,"code":"import { __assign, __rest, __spreadArray } from \"tslib\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport React, { useCallback, useImperativeHandle, useLayoutEffect, useMemo, useRef } from 'react';\nimport clsx from 'clsx';\nimport { getBaseProps } from '../internal/base-component';\nimport { fireNonCancelableEvent } from '../internal/events';\nimport { useStableEventHandler } from '../internal/hooks/use-stable-event-handler';\nimport InternalAttributeEditor from '../attribute-editor/internal';\nimport InternalStatusIndicator from '../status-indicator/internal';\nimport InternalBox from '../box/internal';\nimport { FormFieldError } from '../form-field/internal';\nimport { TagControl, UndoButton } from './internal';\nimport { validate } from './validation';\nimport { findIndex, useMemoizedArray } from './utils';\nimport styles from './styles.css.js';\nimport { applyDisplayName } from '../internal/utils/apply-display-name';\nimport useBaseComponent from '../internal/hooks/use-base-component';\n\nvar isItemRemovable = function isItemRemovable(_a) {\n  var tag = _a.tag;\n  return !tag.markedForRemoval;\n};\n\nvar TagEditor = React.forwardRef(function (_a, ref) {\n  var _b, _c;\n\n  var _d = _a.tags,\n      tags = _d === void 0 ? [] : _d,\n      i18nStrings = _a.i18nStrings,\n      _e = _a.loading,\n      loading = _e === void 0 ? false : _e,\n      _f = _a.tagLimit,\n      tagLimit = _f === void 0 ? 50 : _f,\n      allowedCharacterPattern = _a.allowedCharacterPattern,\n      keysRequest = _a.keysRequest,\n      valuesRequest = _a.valuesRequest,\n      onChange = _a.onChange,\n      restProps = __rest(_a, [\"tags\", \"i18nStrings\", \"loading\", \"tagLimit\", \"allowedCharacterPattern\", \"keysRequest\", \"valuesRequest\", \"onChange\"]);\n\n  var baseComponentProps = useBaseComponent('TagEditor');\n  var remainingTags = tagLimit - tags.filter(function (tag) {\n    return !tag.markedForRemoval;\n  }).length;\n  var attributeEditorRef = useRef(null);\n  var keyInputRefs = useRef([]);\n  var valueInputRefs = useRef([]);\n  var undoButtonRefs = useRef([]);\n  var initialKeyOptionsRef = useRef([]);\n  var keyDirtyStateRef = useRef([]);\n  var focusEventRef = useRef();\n  useLayoutEffect(function () {\n    var _a;\n\n    (_a = focusEventRef.current) === null || _a === void 0 ? void 0 : _a.apply(undefined);\n    focusEventRef.current = undefined;\n  });\n  var errors = validate(tags, keyDirtyStateRef.current, i18nStrings, allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined);\n  var internalTags = useMemoizedArray(tags.map(function (tag, i) {\n    return {\n      tag: tag,\n      error: errors[i]\n    };\n  }), function (prev, next) {\n    var _a, _b, _c, _d;\n\n    return prev.tag === next.tag && ((_a = prev.error) === null || _a === void 0 ? void 0 : _a.key) === ((_b = next.error) === null || _b === void 0 ? void 0 : _b.key) && ((_c = prev.error) === null || _c === void 0 ? void 0 : _c.value) === ((_d = next.error) === null || _d === void 0 ? void 0 : _d.value);\n  });\n  useImperativeHandle(ref, function () {\n    return {\n      focus: function focus() {\n        var _a, _b;\n\n        var errorIndex = findIndex(internalTags, function (_a) {\n          var error = _a.error;\n          return (error === null || error === void 0 ? void 0 : error.key) || (error === null || error === void 0 ? void 0 : error.value);\n        });\n\n        if (errorIndex !== -1) {\n          var refArray = ((_a = internalTags[errorIndex].error) === null || _a === void 0 ? void 0 : _a.key) ? keyInputRefs : valueInputRefs;\n          (_b = refArray.current[errorIndex]) === null || _b === void 0 ? void 0 : _b.focus();\n        }\n      }\n    };\n  }, [internalTags]);\n  var validateAndFire = useCallback(function (newTags) {\n    fireNonCancelableEvent(onChange, {\n      tags: newTags,\n      valid: !validate(newTags, keyDirtyStateRef.current, i18nStrings, allowedCharacterPattern ? new RegExp(allowedCharacterPattern) : undefined).some(function (error) {\n        return error;\n      })\n    });\n  }, [onChange, i18nStrings, allowedCharacterPattern]);\n\n  var onAddButtonClick = function onAddButtonClick() {\n    validateAndFire(__spreadArray(__spreadArray([], tags, true), [{\n      key: '',\n      value: '',\n      existing: false\n    }], false));\n\n    focusEventRef.current = function () {\n      var _a;\n\n      (_a = keyInputRefs.current[tags.length]) === null || _a === void 0 ? void 0 : _a.focus();\n    };\n  };\n\n  var onRemoveButtonClick = useStableEventHandler(function (_a) {\n    var _b;\n\n    var detail = _a.detail;\n    var existing = tags[detail.itemIndex].existing;\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, detail.itemIndex), true), existing ? [__assign(__assign({}, tags[detail.itemIndex]), {\n      markedForRemoval: true\n    })] : [], true), tags.slice(detail.itemIndex + 1), true));\n\n    if (existing) {\n      focusEventRef.current = function () {\n        var _a;\n\n        (_a = undoButtonRefs.current[detail.itemIndex]) === null || _a === void 0 ? void 0 : _a.focus();\n      };\n    } else {\n      keyDirtyStateRef.current.splice(detail.itemIndex, 1);\n      (_b = keyInputRefs.current[detail.itemIndex]) === null || _b === void 0 ? void 0 : _b.focus();\n    }\n  });\n  var onKeyChange = useStableEventHandler(function (value, row) {\n    keyDirtyStateRef.current[row] = true;\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      key: value\n    })], false), tags.slice(row + 1), true));\n  });\n  var onKeyBlur = useStableEventHandler(function (row) {\n    keyDirtyStateRef.current[row] = true; // Force re-render by providing a new array reference\n\n    validateAndFire(__spreadArray([], tags, true));\n  });\n  var onValueChange = useStableEventHandler(function (value, row) {\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      value: value\n    })], false), tags.slice(row + 1), true));\n  });\n  var onUndoRemoval = useStableEventHandler(function (row) {\n    validateAndFire(__spreadArray(__spreadArray(__spreadArray([], tags.slice(0, row), true), [__assign(__assign({}, tags[row]), {\n      markedForRemoval: false\n    })], false), tags.slice(row + 1), true));\n\n    focusEventRef.current = function () {\n      var _a;\n\n      (_a = attributeEditorRef.current) === null || _a === void 0 ? void 0 : _a.focusRemoveButton(row);\n    };\n  });\n  var definition = useMemo(function () {\n    return [{\n      label: i18nStrings.keyHeader,\n      control: function control(_a, row) {\n        var tag = _a.tag;\n        return React.createElement(TagControl, {\n          row: row,\n          value: tag.key,\n          readOnly: tag.existing,\n          limit: 200,\n          defaultOptions: [],\n          placeholder: i18nStrings.keyPlaceholder,\n          errorText: i18nStrings.keysSuggestionError,\n          loadingText: i18nStrings.keysSuggestionLoading,\n          suggestionText: i18nStrings.keySuggestion,\n          tooManySuggestionText: i18nStrings.tooManyKeysSuggestion,\n          enteredTextLabel: i18nStrings.enteredKeyLabel,\n          onRequest: keysRequest,\n          onChange: onKeyChange,\n          onBlur: onKeyBlur,\n          initialOptionsRef: initialKeyOptionsRef,\n          ref: function ref(_ref) {\n            keyInputRefs.current[row] = _ref;\n          }\n        });\n      },\n      errorText: function errorText(_a) {\n        var error = _a.error;\n        return error === null || error === void 0 ? void 0 : error.key;\n      }\n    }, {\n      label: React.createElement(React.Fragment, null, i18nStrings.valueHeader, \" - \", React.createElement(\"i\", null, i18nStrings.optional)),\n      control: function control(_a, row) {\n        var _b;\n\n        var tag = _a.tag;\n        return tag.markedForRemoval ? React.createElement(\"div\", {\n          role: \"alert\"\n        }, React.createElement(InternalBox, {\n          margin: {\n            top: 'xxs'\n          }\n        }, i18nStrings.undoPrompt, ' ', React.createElement(UndoButton, {\n          onClick: function onClick() {\n            return onUndoRemoval(row);\n          },\n          ref: function ref(elem) {\n            undoButtonRefs.current[row] = elem;\n          }\n        }, i18nStrings.undoButton))) : React.createElement(TagControl, {\n          row: row,\n          value: tag.value,\n          readOnly: false,\n          limit: 200,\n          defaultOptions: (_b = tag.valueSuggestionOptions) !== null && _b !== void 0 ? _b : [],\n          placeholder: i18nStrings.valuePlaceholder,\n          errorText: i18nStrings.valuesSuggestionError,\n          loadingText: i18nStrings.valuesSuggestionLoading,\n          suggestionText: i18nStrings.valueSuggestion,\n          tooManySuggestionText: i18nStrings.tooManyValuesSuggestion,\n          enteredTextLabel: i18nStrings.enteredValueLabel,\n          filteringKey: tag.key,\n          onRequest: valuesRequest && function (value) {\n            return valuesRequest(tag.key, value);\n          },\n          onChange: onValueChange,\n          ref: function ref(_ref2) {\n            valueInputRefs.current[row] = _ref2;\n          }\n        });\n      },\n      errorText: function errorText(_a) {\n        var error = _a.error;\n        return error === null || error === void 0 ? void 0 : error.value;\n      }\n    }];\n  }, [i18nStrings, keysRequest, onKeyChange, onKeyBlur, valuesRequest, onValueChange, onUndoRemoval]);\n\n  if (loading) {\n    return React.createElement(\"div\", {\n      className: styles.root,\n      ref: baseComponentProps.__internalRootRef\n    }, React.createElement(InternalStatusIndicator, {\n      className: styles.loading,\n      type: \"loading\"\n    }, i18nStrings.loading));\n  }\n\n  var baseProps = getBaseProps(restProps);\n  return React.createElement(InternalAttributeEditor, __assign({}, baseProps, baseComponentProps, {\n    ref: attributeEditorRef,\n    className: clsx(styles.root, baseProps.className),\n    items: internalTags,\n    isItemRemovable: isItemRemovable,\n    onAddButtonClick: onAddButtonClick,\n    onRemoveButtonClick: onRemoveButtonClick,\n    addButtonText: i18nStrings.addButton,\n    removeButtonText: i18nStrings.removeButton,\n    disableAddButton: remainingTags <= 0,\n    empty: i18nStrings.emptyTags,\n    additionalInfo: React.createElement(\"div\", {\n      \"aria-live\": \"polite\"\n    }, remainingTags < 0 ? React.createElement(FormFieldError, null, (_b = i18nStrings.tagLimitExceeded(tagLimit)) !== null && _b !== void 0 ? _b : '') : remainingTags === 0 ? (_c = i18nStrings.tagLimitReached(tagLimit)) !== null && _c !== void 0 ? _c : '' : i18nStrings.tagLimit(remainingTags, tagLimit)),\n    definition: definition\n  }));\n});\napplyDisplayName(TagEditor, 'TagEditor');\nexport default TagEditor;","map":null,"metadata":{},"sourceType":"module"}